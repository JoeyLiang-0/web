<html>
    <head>
        <title>Reading List Generator</title>
        <style>
            .button
            {
                padding: 2px;
            }
        </style>

        <script type="text/javascript" src="book-list.js"></script>
        <script type="text/javascript" src="latex-gen.js"></script>

        <script type="text/javascript">

            class HtmlGenerator
            {
                // const
                mBookImageRoot = "https://evin0.files.wordpress.com/2020/08/";
                // variables
                mWithExtraBreak = false;
                mResult = "";
                            
                InsertGroupButtons()
                {
                    var buttonAnchor = document.getElementById("buttonAnchor");

                    for (var index = 0; index < books.length; index++)
                    {
                        var bookGroup = books[index];

                        var button = document.createElement("input");
                        button.id = index;
                        button.type = "button";
                        button.value = bookGroup.group;
                        button.onclick = function()
                        {
                            htmlGen.GenerateBookGroup(this.id);
                        }        

                        buttonAnchor.parentNode.insertBefore(button, buttonAnchor.nextSibling);
                        buttonAnchor = button;

                        if (index > 0 && (index+1)%3 == 0 && index < books.length-1)
                        {
                            var br = document.createElement("br");
                            buttonAnchor.parentNode.insertBefore(br, buttonAnchor.nextSibling);
                            buttonAnchor = br;
                        }
                    }
                }                

                CopySourceToClipboard()
                {
                    var copyText = document.getElementById("srcCodeBox");
                    copyText.select();
                    // copyText.setSelectionRange(0, 99999); /*For mobile devices*/
                    document.execCommand("copy");
                }

                StringIsValidAscii(input)
                {
                    for (let c of input)
                    {
                        if (c.charCodeAt(0)<4 || c.charCodeAt(0)>127)
                        {
                            return false;
                        }
                    }

                    return true;
                }

                PreGenerate()
                {
                    this.mWithExtraBreak = document.getElementById("withExtraBreak").checked;
                    this.mResult = "";
                    
                    // check if there is non-ascii charactar
                    for (var groupIndex = 0; groupIndex < books.length; groupIndex++)
                    {
                        for (var bookIndex = 0; bookIndex < books[groupIndex].list.length; bookIndex++)
                        {
                            if (!this.StringIsValidAscii(books[groupIndex].list[bookIndex].title))
                                alert("Invalid character in 'title', " + books[groupIndex].list[bookIndex].title + ", in group " + books[groupIndex].group);
                            if (!this.StringIsValidAscii(books[groupIndex].list[bookIndex].author))
                                alert("Invalid character in 'author', " + books[groupIndex].list[bookIndex].title + ", in group " + books[groupIndex].group);
                            if (!this.StringIsValidAscii(books[groupIndex].list[bookIndex].description))
                                alert("Invalid character in 'description', " + books[groupIndex].list[bookIndex].title + ", in group " + books[groupIndex].group);
                        }
                    }
                }

                FormatBook(book, index) 
                {
                    var bLeft = (index%2 == 0);

                    // some themes' header bar may overlap the content, put link target as top as possible
                    this.mResult += "<hr id=\"book-" + index + "\" style=\"border: 1px solid white; margin-bottom: 10pt;\">\n";
                    this.mResult += "<hr style=\"border:4pt solid #d0d0d0; border-radius: 5pt;\">\n";
                    
                    var imageFile = book.image + ((book.imageSuffix === undefined) ? "" : book.imageSuffix) + ".jpg";

                    this.mResult += "<img align=\"" + (bLeft ? "left" : "right");                
                    this.mResult += "\" width=140 style=\"padding: 10px;\" src=\"" + this.mBookImageRoot + imageFile + "\">\n";

                    this.mResult += "<strong>" + book.title + "</strong><br>\n";
                    this.mResult += "Author(s): <i>" + book.author + "</i><br>\n";
                    this.mResult += book.description.replace(/                    /g, " ") + "\n";
                    
                    if (this.mWithExtraBreak)
                        this.mResult += "<br clear=\"all\">";
                        
                    this.mResult += "\n\n";        
                } 

                FormatBookGroup(bookGroup)
                {
                    this.mResult += "<h4 style=\"padding: 5px; background-color: #d0e0f0;\">" + bookGroup.group + "</h4>\n";
                    this.mResult += "<span style=\"display: block; color: black;\">\n\n";
                    bookGroup.list.forEach(this.FormatBook, this);
                    this.mResult += "\n<br>\n</span>";
                }

                GenerateBookGroup(index)
                {
                    this.PreGenerate();
                    this.FormatBookGroup(books[index]);
                    this.UpdateResult();
                    this.CopySourceToClipboard();
                }

                GenerateSummary()
                {
                    this. PreGenerate();

                    const StyleA = " style=\"color:black; text-decoration: none;\" onmouseover=\"this.style.color='blue'\" onmouseout=\"this.style.color='black'\" ";

                    // pages

                    this.mResult = "<h4>Click for Each Page</h4>\n<ul>\n";
                    for (var groupIndex = 0; groupIndex < books.length; groupIndex++)
                    {
                        this.mResult += "<li><a " + StyleA + "href=\"" + books[groupIndex].page + "\">" + books[groupIndex].group + "</a></li>\n";
                    }
                    this.mResult += "</ul><br><hr>\n\n";

                    // books

                    this.mResult += "<h4>Click for Each Book</h4>\n<dl>";
                    for (var groupIndex = 0; groupIndex < books.length; groupIndex++)
                    {
                        var bookGroup = books[groupIndex];
                        this.mResult += "<p style=\"margin-bottom: 5px;\"><a " + StyleA + "href=\"" + bookGroup.page + "\">" + bookGroup.group + "</a></p>\n";
                        this.mResult += "<ol style=\"margin-top: 0px;\">\n";

                        for (var bookIndex = 0; bookIndex < bookGroup.list.length; bookIndex++)
                        {
                            this.mResult += "<li><a " + StyleA + "href=\"" + bookGroup.page + "#book-" + bookIndex + "\">" + bookGroup.list[bookIndex].title + "</a></li>\n";
                        }
                        this.mResult += "</ol><br>\n";
                    }
                    this.mResult += "<br><br>\n";

                    this.UpdateResult();
                    this.CopySourceToClipboard();
                }

                UpdateResult()
                {
                    document.getElementById("this.mResultBox").innerHTML = this.mResult;
                    document.getElementById("srcCodeBox").value = this.mResult;  
                }
            }
            var htmlGen = new HtmlGenerator();

            function GenerateLaTeX() {
                var texSrc = LatexGenerator.Generate(books);
                var srcBox = document.getElementById("srcCodeBox");
                srcBox.value = texSrc;
                srcBox.select();
                // srcBox.setSelectionRange(0, 99999); /*For mobile devices*/
                document.execCommand("copy");
            }

        </script>            
    </head>

<body>

<label for="withExtraBreak">Extra Break for Local Test: </label><input type="checkbox" id="withExtraBreak" name="Extra Break">
<br id="buttonAnchor"><br>
<button onclick="htmlGen.GenerateSummary()">Summary</button>
<button onclick="htmlGen.CopySourceToClipboard()">Copy</button>
<button onclick="GenerateLaTeX()">LaTex</button>
<br>
<textarea id="srcCodeBox" readonly rows="4" cols="150"></textarea>

<hr>

<p id="this.mResultBox"></p>


<script type="text/javascript">
    htmlGen.InsertGroupButtons();
</script>

</body>
</html>